<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Solanagram{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=202506180002">
    <!-- Corporate Menu Styles -->
    {{ menu_styles|safe }}
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Corporate Navigation Menu -->
    {{ menu_html|safe }}

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Corporate Menu Scripts -->
    {{ menu_scripts|safe }}

    <script>
        // Session validation
        let sessionCheckInterval = null;
        
        // Check session validity
        async function checkSessionValidity() {
            try {
                const response = await fetch('/api/auth/validate-session');
                if (response.ok) {
                    const data = await response.json();
                    if (!data.success || !data.session_valid) {
                        // Session is invalid, logout automatically
                        console.log('Session validation failed, logging out...');
                        await performLogout();
                    }
                } else if (response.status === 401) {
                    // Unauthorized, logout automatically
                    console.log('Unauthorized response, logging out...');
                    await performLogout();
                }
            } catch (error) {
                console.error('Error checking session validity:', error);
                // On error, we don't logout automatically to avoid false positives
            }
        }
        
        // Perform logout
        async function performLogout() {
            try {
                // Clear local storage
                localStorage.removeItem('access_token');
                localStorage.removeItem('session_token');
                
                // Call logout endpoint
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Redirect to login
                window.location.href = '/login';
            } catch (error) {
                console.error('Error during logout:', error);
                // Still redirect to login even if logout fails
                window.location.href = '/login';
            }
        }
        
        // Start session validation on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check session immediately
            checkSessionValidity();
            
            // Set up periodic session checks (every 5 minutes)
            sessionCheckInterval = setInterval(checkSessionValidity, 5 * 60 * 1000);
            
            // Also check when page becomes visible (user returns to tab)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    checkSessionValidity();
                }
            });
        });
        
        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
        });
        
        // Show message function - Unified error/message system
        function showMessage(message, type = 'info') {
            // Remove any existing messages to avoid duplicates
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => {
                if (msg.parentNode) {
                    msg.parentNode.removeChild(msg);
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            
            // Create close button
            const closeButton = document.createElement('button');
            closeButton.className = 'message-close';
            closeButton.innerHTML = '&times;';
            closeButton.setAttribute('aria-label', 'Chiudi messaggio');
            closeButton.onclick = function() {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            };
            
            // Create message content
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = message; // Using innerHTML to support HTML content
            
            // Assemble message
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(closeButton);
            
            // Insert at top of main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(messageDiv, mainContent.firstChild);
            }
            
            // Scroll to message for better visibility
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // API request helper - Enhanced with unified error handling
        async function makeRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            // Get token from server session
            let token = null;
            try {
                const tokenResponse = await fetch('/api/auth/session-token');
                if (tokenResponse.ok) {
                    const tokenData = await tokenResponse.json();
                    if (tokenData.success) {
                        token = tokenData.token;
                    }
                }
            } catch (e) {
                console.log('Could not get session token:', e);
            }
            
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                // Handle 401 Unauthorized
                if (response.status === 401) {
                    // Session expired, perform automatic logout
                    console.log('Session expired during API request, logging out...');
                    await performLogout();
                    return null;
                }
                
                const data = await response.json();
                
                // Handle API errors that return success: false or error fields
                if (data && data.success === false && data.error) {
                    const errorMessage = typeof data.error === 'string' ? data.error : 'Errore sconosciuto';
                    if (!options.suppressErrorMessage) {
                        showMessage(`❌ ${errorMessage}`, 'error');
                    }
                    return data; // Return the data even if there's an error for specific handling
                }
                
                // Handle server errors (5xx status codes)
                if (response.status >= 500) {
                    if (!options.suppressErrorMessage) {
                        showMessage('❌ Errore del server. Riprova più tardi.', 'error');
                    }
                    return { success: false, error: 'Server error' };
                }
                
                // Handle client errors (4xx status codes except 401)
                if (response.status >= 400 && response.status < 500) {
                    const errorMessage = data?.error || data?.message || 'Richiesta non valida';
                    if (!options.suppressErrorMessage) {
                        showMessage(`❌ ${errorMessage}`, 'error');
                    }
                    return data || { success: false, error: errorMessage };
                }
                
                return data;
            } catch (error) {
                console.error('Request error:', error);
                if (!options.suppressErrorMessage) {
                    showMessage('❌ Errore di connessione. Verifica la tua connessione internet.', 'error');
                }
                throw error;
            }
        }
        
        // Global error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showMessage('❌ Si è verificato un errore imprevisto.', 'error');
        });
        
        // Global error handler for JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
            // Only show message for critical errors, not for minor issues
            if (event.error && event.error.stack && !event.error.stack.includes('extension')) {
                showMessage('❌ Errore nell\'applicazione. Ricarica la pagina se i problemi persistono.', 'error');
            }
        });

        // Loading state helpers
        function showLoading() {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(element => {
                element.style.display = 'block';
            });
        }

        function hideLoading() {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(element => {
                element.style.display = 'none';
            });
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html> 